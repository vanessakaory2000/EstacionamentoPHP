<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Estacionamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">
        Sistema de Estacionamento
      </h1>

      <!-- Formulário de Entrada -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">
          Registrar Entrada
        </h2>
        <form id="entryForm" class="space-y-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2"
              >Placa do Veículo</label
            >
            <input
              type="text"
              id="entryPlate"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="ABC-1234"
              required
            />
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2"
              >Tipo de Veículo</label
            >
            <select
              id="entryVehicleType"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="carro">Carro</option>
              <option value="moto">Moto</option>
              <option value="caminhao">Caminhão</option>
            </select>
          </div>
          <button
            type="submit"
            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200"
          >
            Registrar Entrada
          </button>
        </form>
      </div>

      <!-- Veículos no Pátio -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold text-gray-700">
            Veículos no Pátio
          </h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full border border-gray-200 text-left text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 border-b">ID</th>
                <th class="px-4 py-2 border-b">Placa</th>
                <th class="px-4 py-2 border-b">Tipo</th>
                <th class="px-4 py-2 border-b">Entrada</th>
                <th class="px-4 py-2 border-b">Ações</th>
              </tr>
            </thead>
            <tbody id="openSessionsBody"></tbody>
          </table>
          <p id="openSessionsEmpty" class="text-center text-gray-500 mt-4">
            Nenhum veículo no pátio.
          </p>
        </div>
      </div>

      <!-- Botão Relatório -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Relatórios</h2>
        <div class="flex gap-4">
          <button
            onclick="viewReport()"
            class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md transition duration-200"
          >
            Ver Relatório
          </button>
          <button
            onclick="downloadPdf()"
            class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-200"
          >
            Baixar PDF
          </button>
        </div>
      </div>
    </div>
  </body>
  <script>
    const BASE_PATH = "/parking";
    const API_BASE = `${BASE_PATH}/api`;

    const apiFetch = (endpoint, options = {}) =>
      fetch(`${API_BASE}${endpoint}`, options);

    // Registrar Entrada
    document
      .getElementById("entryForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        const plate = document.getElementById("entryPlate").value;
        const vehicleType = document.getElementById("entryVehicleType").value;

        try {
          const response = await apiFetch("/entry", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ plate, vehicleType }),
          });

          const data = await response.json();

          if (response.ok) {
            Swal.fire({
              icon: "success",
              title: "Entrada Registrada!",
              text: `Veículo ${plate} registrado com sucesso.`,
              confirmButtonColor: "#3b82f6",
            });
            document.getElementById("entryForm").reset();
            await loadOpenSessions();
          } else {
            Swal.fire({
              icon: "error",
              title: "Erro!",
              text: data.error || "Erro ao registrar entrada.",
              confirmButtonColor: "#ef4444",
            });
          }
        } catch (error) {
          Swal.fire({
            icon: "error",
            title: "Erro!",
            text: "Erro de conexão com o servidor.",
            confirmButtonColor: "#ef4444",
          });
        }
      });

    // Ver Relatório
    async function viewReport() {
      try {
        const response = await apiFetch("/report");
        const data = await response.json();

        if (response.ok) {
          let html = '<div class="text-left">';

          data.forEach((item) => {
            html += `
                            <div class="mb-4 p-3 bg-gray-50 rounded">
                                <p><strong>Tipo:</strong> ${
                                  item.vehicleType
                                }</p>
                                <p><strong>Total de Sessões:</strong> ${
                                  item.totalSessions
                                }</p>
                                <p><strong>Valor Total:</strong> R$ ${item.totalAmount.toFixed(
                                  2
                                )}</p>
                            </div>
                        `;
          });

          html += "</div>";

          Swal.fire({
            icon: "info",
            title: "Relatório de Estacionamento",
            html: html,
            width: "600px",
            confirmButtonColor: "#8b5cf6",
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Erro!",
            text: "Erro ao carregar relatório.",
            confirmButtonColor: "#ef4444",
          });
        }
      } catch (error) {
        Swal.fire({
          icon: "error",
          title: "Erro!",
          text: "Erro de conexão com o servidor.",
          confirmButtonColor: "#ef4444",
        });
      }
    }

    // Baixar PDF
    function downloadPdf() {
      window.open(`${API_BASE}/report?format=pdf`, "_blank");
    }

    // Lista veículos com saída pendente
    async function loadOpenSessions() {
      const tbody = document.getElementById("openSessionsBody");
      const emptyMessage = document.getElementById("openSessionsEmpty");

      tbody.innerHTML = "";
      emptyMessage.textContent = "Nenhum veículo no pátio.";
      emptyMessage.classList.add("hidden");

      try {
        const response = await apiFetch("/open-sessions");
        const payload = await response.json();

        if (!response.ok || !payload.success) {
          throw new Error(payload.error || "Erro ao carregar lista.");
        }

        if (!payload.data || payload.data.length === 0) {
          emptyMessage.classList.remove("hidden");
          return;
        }

        payload.data.forEach((session) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-50";
          row.innerHTML = `
                        <td class="px-4 py-2 border-b">${session.id}</td>
                        <td class="px-4 py-2 border-b font-semibold">${session.plate}</td>
                        <td class="px-4 py-2 border-b">${session.vehicleType}</td>
                        <td class="px-4 py-2 border-b">${session.entryTime}</td>
                        <td class="px-4 py-2 border-b">
                          <button
                            class="register-exit bg-green-500 hover:bg-green-600 text-white text-sm font-semibold py-1 px-3 rounded"
                            data-session-id="${session.id}"
                          >
                            Registrar Saída
                          </button>
                        </td>
                    `;
          tbody.appendChild(row);

          const exitButton = row.querySelector(".register-exit");
          exitButton.addEventListener("click", async () => {
            exitButton.disabled = true;
            exitButton.classList.add("opacity-70", "cursor-not-allowed");
            await registerExit(session, exitButton);
          });
        });
      } catch (error) {
        emptyMessage.textContent =
          "Não foi possível carregar a lista de veículos.";
        emptyMessage.classList.remove("hidden");
      }
    }

    async function registerExit(session, button) {
      try {
        const response = await apiFetch("/exit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ parkingSessionId: session.id }),
        });

        const payload = await response.json();

        if (!response.ok || !payload.success) {
          throw new Error(payload.error || "Erro ao registrar saída.");
        }

        const amount = Number(payload.amount ?? 0);

        Swal.fire({
          icon: "success",
          title: "Saída Registrada!",
          html: `
              <p><strong>Placa:</strong> ${payload.plate}</p>
              <p><strong>Tipo:</strong> ${payload.vehicleType}</p>
              <p><strong>Horas:</strong> ${payload.hours}h</p>
              <p><strong>Valor:</strong> R$ ${amount.toFixed(2)}</p>
            `,
          confirmButtonColor: "#10b981",
        });

        await loadOpenSessions();
      } catch (error) {
        Swal.fire({
          icon: "error",
          title: "Erro!",
          text: error.message,
          confirmButtonColor: "#ef4444",
        });

        if (button) {
          button.disabled = false;
          button.classList.remove("opacity-70", "cursor-not-allowed");
        }

        return;
      }
    }
    // Inicializa página
    loadOpenSessions();
  </script>
</html>
